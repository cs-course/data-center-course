---
marp: true
theme: gaia
title: 软件技术基础
# size: 4:3
math: katex
---

<!-- _class: lead -->

# 软件技术基础

## 编译预处理

**施展**
武汉光电国家研究中心 & 计算机学院
华中科技大学

---

## 本章重点
- 宏定义 `#define`
  - 无参宏定义
  - 带参宏定义 ✅
- 条件编译

---

## 编译预处理
- **编译预处理**：在编译之前，由预处理程序完成的工作。
- **预处理指令**：以 `#` 开头的指令。

---

## 文件包含 `#include`
用指定文件的内容取代该预处理指令行：

1. `#include <文件名>`  
   在标准目录下寻找。

2. `#include "文件名"`  
   先在当前目录寻找，找不到再去标准目录。

---

## 宏定义 `#define`
用一个标识符（宏名）表示一个字符串。

```c
#define M (y*y+3*y)
```

- **宏代换（宏展开）**：预处理时用字符串替换宏名。

---

### 宏展开示例
**预处理前：**
```c
#define M (y*y+3*y)
void main(void){
    int s, y;
    scanf("%d",&y);
    s = 3*M + 4*M + y*M;
}
```

**预处理后：**
```c
void main(void){
    int s, y;
    scanf("%d",&y);
    s = 3*(y*y+3*y) + 4*(y*y+3*y) + y*(y*y+3*y);
}
```

---

### 带参数的宏定义
```c
#define SQ(x) ((x)*(x))
```

- **宏调用**：`SQ(a+1)`
- **宏展开**：`((a+1)*(a+1))`

---

### 宏展开嵌套示例
```c
SQ(SQ(a))
// 展开：((((a)*(a))) * (((a)*(a))))
```

---

### 为什么要这么多括号？
- 错误示例1：
  ```c
  #define SQ(x) x*x
  SQ(a+b) // 展开：a+b*a+b ❌
  ```

- 错误示例2：
  ```c
  #define SQ(x) (x)*(x)
  27/SQ(3) // 展开：27/(3)*(3) ❌
  ```

> ✅ 每个参数和整体表达式都要加括号！

---

### 宏定义常见错误
```c
#define SQ (x) ((x)*(x))  // ❌ 宏名与括号间不能有空格
```

---

### 宏的特点
- ✅ 节省函数调用开销，速度快
- ✅ 不分配内存，不需类型说明
- ❌ 展开后源程序变长
- ✅ 适合简短表达式和重复代码

---

## 取消宏定义 `#undef`
终止宏名的作用域：
```c
#undef 标识符
```

用途：
- 防止宏名冲突
- 确保调用的是函数而非宏

---

## 条件编译
根据条件选择性地包含程序部分，生成不同目标代码。

三种形式：
- `#if`
- `#ifdef`
- `#ifndef`

---

### 条件编译示例1：计算圆面积
**预处理前：**
```c
#define R
int main(void){
    float r, s;
    scanf("%f",&r);
#ifdef R
    s = 3.14159*r*r;
#else
    s = r*r;
#endif
}
```

**预处理后（定义了R）：**
```c
int main(void){
    float r, s;
    scanf("%f",&r);
    s = 3.14159*r*r;
}
```

---

### 条件编译示例2：计算正方形面积
**预处理前：**
```c
// #define R
int main(void){
    float c, s;
    scanf("%f",&c);
#ifdef R
    s = 3.14159*c*c;
#else
    s = c*c;
#endif
}
```

**预处理后（未定义R）：**
```c
int main(void){
    float c, s;
    scanf("%f",&c);
    s = c*c;
}
```

---

### 条件编译应用：调试程序
**忽略代码：**
```c
#if 0
    // 不编译的代码
#endif
```

**跟踪调试：**
```c
#define DEBUG
#ifdef DEBUG
    printf("x=%d\n", x);
#endif
```

---

## assert宏
头文件：`assert.h`

```c
assert(e);
```

- 表达式为假时输出错误信息并中断执行：
  ```
  Assertion failed: e, file test.c, line 32
  ```

---

### 断言与防御性编程
- 断言是一种简单有效的防御性编程手段。
- 在开发阶段快速暴露错误。

---

### 断言流程图
```mermaid
flowchart TD
    A[assert(e)] --> B{e为真？}
    B -->|是| C[继续执行]
    B -->|否| D[输出错误信息\n文件、行号]
    D --> E[程序中断]
```

---

### 总结
- 宏定义用于代码复用和性能优化。
- 条件编译用于跨平台、调试和代码裁剪。
- 断言用于开发和调试阶段的错误检测。

